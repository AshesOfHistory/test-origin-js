# 王鹏权益超市离职交接文档

由于本人个人原因，将于8.2日离职，需要在此前完成工作内容交接。
我负责权益超市核心业务模块的开发与维护，首页渲染业务逻辑复杂，以及日常组件开发时会遇到一些问题，特此书写此文档说明。

### 文档交接主要接收人
谢志，翁江鹏

### 工作交接主要内容
- 首页渲染逻辑流程
- 单点登录流程
- tab组件栏核心业务逻辑与校验逻辑
- 管理台编辑栏公用配置组件逻辑
- 用户身份卡组件业务逻辑
- 封装的一些工具函数的介绍与使用
- 组件开发流程步骤梳理
- 组件开发过程部分问题的解决方法
- 首屏加载的未来优化方向探索

99 首页渲染优化未来优化方向探索，组件分包加载。首页用到的组件预先加载，其余的组件打包到另一个包。   ssr服务端渲染，前端请求作bff分层...当然这些方案对于技术实力的要求会比较高

1. 页面初始化加载，对比当前用户数据与缓存用户数据是否不同（不同会刷新页面）,注册自定义分享监听时间shareEvent（触发该自定义事件的时候，实际上是等拿到页面分享信息的时候触发，会调用initShare方法初始化分享参数），网络异常页面逻辑初始化，动态获取url上的各个参数并缓存到本地localStorage，获取当前h5页面的环境前缀相关配置，单点登录流程，页面json获取流程，页面渲染。
单点登录区分各个端，h5，小程序，手厅app，其他省厅app，调用ssoLogin下面封装的单点登录的方法
```
weiTingSSO,
appSSO,
ssoCheck,
addUid,
login,
```

2. 组件开发流程梳理
- 确定对应的组件母版名称，在组件母版库中注册。
- 注册完毕后，在对应站点文件夹下，创建对应组件母版的文件夹，里面新建index.vue,edit.vue,img文件夹（放置图片）。
- 其中需要注意的是，H5端普通组件的index中name不带站点前缀，需要涉及到组件内部渲染子页面的复合组件时（比如tab栏组件，会员swiper页）需要带上站点前缀，**且需要放在views/common文件目录下**，若带子页面渲染的复合组件放置在views/components文件夹下与普通组件放在一起会有问题。

3. tab组件栏核心功能逻辑
动态切换，数据格式自定义，


### 组件开发过程一些问题的探索解决方案
1. 组件开发时，h5端可能会需要根据手机屏幕动态渲染对应屏幕尺寸大小的图片，而图片url又是从组件json中异步获取到的，不会被动态转换成rem？
- 由于px2rem插件只能在打包时生成编译后的代码文件时动态转化成rem，所以异步获取到的图片需要自己手动指定宽高，但是定宽在小屏手机时容易产生折行溢出的bug，所以我们需要根据新建img对象，监听其onload事件，回调函数中获取其宽高，获取手机屏幕实际宽度，再乘上屏幕宽度/375，也就是实际需要的放大系数，最后为新宽度复制。此时需要注意的是，运营上传图片的时候通常是用的@2x的图片，需要在h5端这边手动除以2

```javascript
initScaleImgWH(item, handleWidthStr, handleHeightStr, handleImgResourceStr) {
  const height = 26
  const img = new Image()
  img.onload = () => {
    const originWHRatio = img.width / img.height
    this.$set(item, handleWidthStr, height * originWHRatio + 'px')
    this.$set(item, handleHeightStr, height + 'px')
  }
  img.src = item[handleImgResourceStr]
},
```

参见上述代码，在rightsmarket-h5-canvas项目下views/common/goodsBanner/index.vue 228行
这边将初始化图片宽高封装成一个工具函数，接收传入的vue组件的data字段，传入指定的修改的宽高对应参数，以及图片url。
- 这边运用到一个小技巧，结构化的数据中，是可以通过自定义一些便于前端渲染的辅助字段的。
之前有最多10个tab栏组件，为了获取这是个tab栏组件对应的各个图片对应的值，一开始我使用了tab0Width，tab1Width这种形式的参数但是后来发现还有子tab属性，通过这种形式就十分不方便了，于是我修改了下tab组件的数据结构，采用[{tabItem:[], imgHeight: ''}]这种形式，把原始图片，激活态图片，角标图片对应的异步计算的值赋值到对应的字段中。
- 由于组件的开发过程中的自定义字段具有极大的自由性，我们可以十分方便的创建更有利于页面渲染的数据结构。
2. 组件在PC端预览态以及依赖于编辑态控制显示隐藏的预览图片样式在左边侧边栏和中间编辑区的预览态互斥问题
- 由于左边侧边栏是预览区，需要一直展示预览态，中间的编辑区会因编辑区的指定参数填写之后使得预览图消失。但是由于左边栏与中间编辑区使用的是同一个组件渲染逻辑，逻辑存在耦合，所以我们需要对两种情况进行区分。
- 下面以canvas-manager-web项目下views/components/rights/goodsBanner/index.vue为例
```html
<div v-if="showPrivew && !firstTabDesc">
  <img v-if="gotInfo && !gotInfo.isHiddenMiddelPreview" :src="preview" alt="" width="100%">
  <img v-else-if="!firstTabDesc" :src="preview" alt width="100%">
</div>
```
- 可以看见这边用showPrivew来控制是否展示预览图，内部使用了业务逻辑变量firstTabDesc。在左边侧边栏的预览态时候不会有这个业务字段的，且有个isHiddenMiddelPreview字段标识当前处于左侧预览态，该字段是在编辑页主逻辑中添加的。
- 在page/edit/index.vue, 1241行compAdd方法控制了组件拖拽到编辑区域之后的逻辑，在1282行针对拖拽的组件进行判断，若拖拽的是组件母版的话，添加isHiddenMiddelPreview属性并赋值为true，拖拽的是组件实例的话则不处理。
```javascript
compInfo.isHiddenMiddelPreview = true;
```
```javascript
watch: {
    info: {
      handler(info) {
        this.gotInfo = info
        if (this.gotInfo && this.gotInfo.tabsList && this.gotInfo.tabsList.length) {
          if (this.gotInfo.tabsList[0].subTabsList && this.gotInfo.tabsList[0].subTabsList.length) {
            this.firstTabDesc = this.gotInfo.tabsList[0].subTabsList[0].desc
          }
        }
        this.initImg()
      },
      deep: true, // 深度监听
      immediate: true // 组件初始化时监听
    }
  },
```
这边动态监听组件编辑区的info，并获取tabsList第0个中的desc字段赋值给firstTabDesc，通过该字段是否存在来控制编辑区内容是否填写，该业务字段的判断可以根据组件的实际内容动态修改。
3. 首页监听路由逻辑作用
- 详情页切换的时候是直接在vuex的路由状态栈中直接push的，url虽然更新但是页面不会重新渲染，我们的分享信息需要监听该url的变化并实时动态更改
```javascript
 watch: {
    $route: {
      handler(val) {
        let { page, env } = val.params;
        this.page = page
        if (env != "grey" && env != "online") {
          // 环境输入异常地址，直接跳转到网络异常页
          this.$toast("请检查输入的地址是否正确");
          this.$router.replace("/networkError");
        } else {
          console.log("handleRouteChange");
          this.getJSON(page, env);
        }
      },
      deep: true,
    },
```
- 可以看到这边监听到路由变化直接重新走了一边getJSON的逻辑，得益于json的时间戳缓存，页面加载速度并不会收到过多的影响。这一块逻辑未来也许可以优化，只针对路由变化后影响的范围专门做逻辑处理，但是之前做了一些初步的尝试影响到详情页的下单逻辑了，又改了回去，此处修改需要慎重。


### 菜单新增流程
首先在线表格一级菜单   页面编排系统下面放入一级菜单
https://docs.qq.com/sheet/DZEt0RUZLSlpEdnR6?tab=BB08J2
确定子菜单的中文名称，路径地址。